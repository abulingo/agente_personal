<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Personal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style> 
        .no-scrollbar::-webkit-scrollbar { display: none; } 
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; } 
        /* Estilo m치s casual tipo chat de amigos */
        .bubble-me { background-color: #dcf8c6; color: #000; border-radius: 12px 0px 12px 12px; }
        .bubble-you { background-color: #fff; color: #000; border-radius: 0px 12px 12px 12px; }
    </style>
</head>
<body class="bg-[#e5ddd5] min-h-screen flex items-center justify-center font-sans">

    <div id="error-screen" class="hidden text-center p-8 bg-white rounded-lg shadow-lg">
        <h2 class="text-xl font-bold text-red-500">Link no v치lido</h2>
        <p class="text-gray-600">No se encontr칩 al usuario.</p>
    </div>

    <div id="login-screen" class="hidden w-full max-w-md bg-white rounded-xl shadow-xl p-8 m-4">
        <div class="text-center mb-6">
            <div class="bg-green-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-white shadow-lg">
                <i class="fab fa-whatsapp text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Hola! 游녦</h2>
            <p id="agent-welcome" class="text-gray-500 text-sm mt-1">Ingresa tu n칰mero para charlar.</p>
        </div>
        <form id="login-form" class="space-y-4">
            <input type="tel" id="user-phone" placeholder="Tu n칰mero de celular" class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:border-green-500 bg-gray-50" required>
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition shadow">Entrar al chat</button>
        </form>
    </div>

    <div id="chat-screen" class="hidden w-full max-w-md bg-[#efeae2] h-[100vh] md:h-[600px] md:rounded-xl md:shadow-2xl flex flex-col relative overflow-hidden">
        <div class="bg-[#075e54] p-3 flex items-center shadow-md z-10 text-white">
            <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 mr-3 overflow-hidden">
                <i class="fas fa-user"></i>
            </div>
            <div>
                <h3 id="chat-header-name" class="font-bold text-sm">Amigo</h3>
                <p class="text-green-100 text-xs opacity-80">en l칤nea</p>
            </div>
        </div>

        <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar bg-[url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png')] bg-repeat opacity-90"></div>
        
        <div class="p-2 bg-[#f0f2f5]">
            <form id="chat-form" class="flex items-center gap-2">
                <input type="text" id="message-input" class="flex-1 p-3 rounded-full border-none shadow-sm focus:outline-none" placeholder="Escribe un mensaje..." autocomplete="off">
                <button type="submit" class="bg-[#008f69] text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-[#007a5a] shadow"><i class="fas fa-paper-plane text-sm"></i></button>
            </form>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://gpubjtiepeqlwkoxoogz.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwdWJqdGllcGVxbHdrb3hvb2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MDk3NzUsImV4cCI6MjA4MjE4NTc3NX0.IwvZDMfx1f38DlDqFeF1IEsMYxbFCWKlEj98GJnadpU';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let agentId = null;     
        let agentApiKey = null; 
        let agentPrompt = null; 
        let agentName = "Amigo";
        let currentLeadId = null;
        let lastMessageCount = 0;

        const urlParams = new URLSearchParams(window.location.search);
        const refParam = urlParams.get('ref'); 

        if (!refParam) {
            document.getElementById('error-screen').classList.remove('hidden');
        } else {
            initAgentData(refParam);
        }

        async function initAgentData(id) {
            const { data: usuario, error } = await supabaseClient
                .from('usuarios')
                .select('id, nombre, gemini_api_key, system_prompt')
                .eq('id', id)
                .single();

            if (error || !usuario) {
                document.getElementById('error-screen').classList.remove('hidden');
                return;
            }

            agentId = usuario.id;
            agentApiKey = usuario.gemini_api_key;
            agentPrompt = usuario.system_prompt;
            agentName = usuario.nombre;
            
            // Personalizar interfaz con nombre real
            document.getElementById('agent-welcome').textContent = `Habla con ${usuario.nombre}`;
            document.getElementById('chat-header-name').textContent = usuario.nombre;
            document.getElementById('login-screen').classList.remove('hidden');
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('user-phone').value.trim();
            if(!phone) return;

            let { data: lead } = await supabaseClient.from('leads').select('*').eq('whatsapp', phone).eq('agent_id', agentId).single();

            if (!lead) {
                const { data: newLead, error } = await supabaseClient
                    .from('leads')
                    .insert([{ whatsapp: phone, agent_id: agentId }])
                    .select().single();
                if(error) { alert("Error"); return; }
                lead = newLead;
            }

            currentLeadId = lead.id;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');
            document.getElementById('chat-screen').classList.add('flex');
            
            cargarMensajes();
            setInterval(cargarMensajes, 3000);
        });

        function appendMessageUI(text, type) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            
            // L칩gica de estilos tipo WhatsApp
            if (type === 'cliente') {
                div.className = 'flex justify-end';
                div.innerHTML = `<div class="bubble-me py-2 px-3 max-w-[85%] shadow-sm text-sm break-words">${marked.parse(text)}</div>`;
            } else if (type === 'ai') {
                div.className = 'flex justify-start';
                div.innerHTML = `<div class="bubble-you py-2 px-3 max-w-[85%] shadow-sm text-sm border border-gray-100 break-words">${marked.parse(text)}</div>`;
            } else if (type === 'agente') {
                div.className = 'flex justify-start';
                div.innerHTML = `<div class="bg-blue-100 text-gray-800 rounded-tr-xl rounded-br-xl rounded-bl-xl py-2 px-3 max-w-[85%] shadow-sm text-sm border border-blue-200"><span class="text-[10px] font-bold text-blue-500 block uppercase">Soporte</span>${text}</div>`;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function cargarMensajes() {
            if (!currentLeadId) return;
            const { data: msgs } = await supabaseClient
                .from('mensajes_leads')
                .select('*')
                .eq('lead_id', currentLeadId)
                .order('created_at', { ascending: true });

            if (msgs && msgs.length > lastMessageCount) {
                const container = document.getElementById('messages-container');
                container.innerHTML = ''; 
                msgs.forEach(msg => appendMessageUI(msg.contenido, msg.origen));
                lastMessageCount = msgs.length;
            }
        }

        // --- L칍GICA IA MEJORADA (CON MEMORIA) ---
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = '';
            appendMessageUI(text, 'cliente');
            
            await supabaseClient.from('mensajes_leads').insert([{ lead_id: currentLeadId, origen: 'cliente', contenido: text }]);

            try {
                // 1. RECUPERAR HISTORIAL RECIENTE (Para que tenga memoria)
                const { data: historyData } = await supabaseClient
                    .from('mensajes_leads')
                    .select('origen, contenido')
                    .eq('lead_id', currentLeadId)
                    .order('created_at', { ascending: false })
                    .limit(10); // Recordar los 칰ltimos 10 mensajes

                // 2. Formatear historial para Gemini
                // Invertimos porque 'limit' trae los 칰ltimos pero el chat es cronol칩gico
                const history = historyData.reverse().map(msg => ({
                    role: msg.origen === 'cliente' ? 'user' : 'model',
                    parts: [{ text: msg.contenido }]
                }));

                // 3. Crear instrucci칩n del sistema
                // Agregamos el prompt personalizado del usuario como "System Instruction" simulada
                const systemPart = {
                    role: "user",
                    parts: [{ 
                        text: `INSTRUCCIONES DE SISTEMA: ${agentPrompt}
                        
                        REGLAS DE FORMATO OBLIGATORIAS:
                        1. Tus respuestas deben ser MUY CORTAS (M치ximo 2 oraciones si es posible).
                        2. Ve directo al grano. No saludes ni te despidas en cada mensaje.
                        3. Elimina palabras innecesarias. Solo entrega la informaci칩n que pide el usuario.
                        4. Si es una conversaci칩n casual, responde como en WhatsApp: r치pido y simple.` 
                    }]
                };

                // Unimos: Prompt Sistema + Historial + Mensaje Nuevo (que ya est치 en historyData si la BD fue r치pida, si no, lo agregamos)
                // Nota: Para asegurar fluidez, enviamos: System -> Historial
                
                const finalContents = [systemPart, ...history];

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${agentApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: finalContents })
                });

                const data = await response.json();
                let aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "...";

                await supabaseClient.from('mensajes_leads').insert([{ lead_id: currentLeadId, origen: 'ai', contenido: aiResponse }]);
                appendMessageUI(aiResponse, 'ai');

            } catch (error) {
                console.error(error);
            }
        });
    </script>
</body>
</html>